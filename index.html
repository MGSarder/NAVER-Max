<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VN Student Planner — Auth (Firebase)</title>
  <style>
    :root{--bg:#f4f6f8;--card:#fff;--muted:#6b7280;--accent:#0ea5a4;--danger:#ef4444}
    *{box-sizing:border-box} body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#0f172a}
    .wrap{max-width:1100px;margin:24px auto;padding:18px}
    header{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center}
    input[type="text"], input[type="search"], select, input[type="datetime-local"], textarea, input[type="number"], input[type="email"], input[type="password"]{padding:8px;border:1px solid #e6e9ee;border-radius:8px;font-size:14px}
    button{cursor:pointer;border:1px solid #e6e9ee;background:var(--card);padding:8px 10px;border-radius:8px}
    .btn-primary{background:var(--accent);color:white;border-color:transparent}
    .btn-danger{background:transparent;color:var(--danger);border-color:var(--danger)}
    .panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 1px 4px rgba(2,6,23,0.06)}
    .grid{display:grid;gap:12px}
    .grid.cards{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .task-card{padding:12px;border-radius:10px;border:1px solid #eef2f7;background:linear-gradient(180deg,#fff,#fcfeff)}
    .task-title{font-weight:600;margin-bottom:6px}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px}
    .flex{display:flex;align-items:center;gap:8px}
    .space-between{display:flex;justify-content:space-between;align-items:center}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-cell{min-height:92px;padding:8px;border-radius:8px;border:1px dashed #eef3f6;background:linear-gradient(180deg,#fff,#fbfeff);cursor:pointer}
    .cal-other{opacity:0.45}
    .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:flex-start;justify-content:center;padding:28px;z-index:60}
    .modal{width:100%;max-width:720px;background:var(--card);padding:18px;border-radius:12px}
    .row{display:flex;gap:8px}
    .col{flex:1}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    @media (max-width:720px){.row{flex-direction:column}}
    .btn-small{padding:6px 8px;border-radius:8px;font-size:13px}
    .done{opacity:0.6;text-decoration:line-through}
    .user-pill{padding:6px 10px;border-radius:999px;border:1px solid #e6eef0;background:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>VN Student Planner</h1>
        <div class="sub">Quản lý nhiệm vụ cho sinh viên — per-account storage (Firebase Auth + Firestore)</div>
      </div>

      <div class="controls">
        <input id="search" type="search" placeholder="Search tasks or notes..." />
        <select id="filterCourse"><option>All</option></select>

        <div class="panel" style="display:flex;gap:6px;align-items:center">
          <button data-view="List" class="btn-small">List</button>
          <button data-view="Calendar" class="btn-small">Calendar</button>
          <button data-view="Course" class="btn-small">Course</button>
          <button data-view="Timeline" class="btn-small">Timeline</button>
        </div>

        <button id="btnAdd" class="btn-primary">Add</button>

        <div id="authArea" class="panel" style="display:flex;gap:8px;align-items:center">
          <!-- Will be controlled by JS: sign-in form or user info -->
          <div id="authUI">
            <button id="openLogin" class="btn-small">Sign in / Register</button>
          </div>
        </div>
      </div>
    </header>

    <main id="app">
      <div class="sub" id="stats">Loading...</div>
      <section id="viewArea" style="margin-top:12px"></section>

      <section style="margin-top:14px" class="grid" id="extras">
        <div class="panel">
          <div style="display:flex;justify-content:space-between">
            <div class="small"><b>Quick stats</b></div>
            <div class="small">
              <button id="seedBtn" class="btn-small">Seed 30</button>
              <button id="clearBtn" class="btn-small btn-danger">Clear (local)</button>
            </div>
          </div>
          <div style="margin-top:8px" id="quickStats" class="muted small"></div>
        </div>

        <div class="panel">
          <div class="small"><b>Tips</b></div>
          <ul class="muted small">
            <li>Sign in to keep tasks per account across devices.</li>
            <li>Use Calendar to spot overloaded days.</li>
            <li>Group by course for teamwork planning.</li>
          </ul>
        </div>
      </section>

      <footer>
        <div>Storage: <span id="storageMode">guest (localStorage)</span></div>
      </footer>
    </main>
  </div>

  <div id="modalRoot" style="display:none"></div>

  <!-- Firebase modular SDK imports inside module script -->
  <script type="module">
  // ====== CONFIGURE FIREBASE BELOW ======
  // Replace with your project's Firebase config. Leave null to use guest/local mode.
  const firebaseConfig = {
    // apiKey: "YOUR_API_KEY",
    // authDomain: "YOUR_PROJECT.firebaseapp.com",
    // projectId: "YOUR_PROJECT_ID",
    // storageBucket: "YOUR_PROJECT.appspot.com",
    // messagingSenderId: "....",
    // appId: "1:...:web:..."
  };
  // ======================================

  // Load Firebase only if user provided config keys
  let firebaseAvailable = false;
  let app = null, auth = null, db = null;
  if (firebaseConfig && firebaseConfig.apiKey) {
    try {
      // dynamic imports from CDN
      const [{ initializeApp }, { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut ], { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, onSnapshot, query, orderBy, updateDoc, deleteDoc }] = await (async () => {
        const modApp = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js');
        const modAuth = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
        const modDb = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
        return [modApp, modAuth, modDb];
      })();
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      firebaseAvailable = true;
      console.log('Firebase initialized — auth + firestore ready');
    } catch (err) {
      console.error('Firebase load failed', err);
      firebaseAvailable = false;
    }
  } else {
    firebaseAvailable = false;
    console.log('No Firebase config provided — running in local guest mode');
  }

  // ---- App state & utilities (similar to previous local version) ----
  const STORAGE_KEY = 'vn-student-planner-html-v2';
  let tasks = [];
  let view = 'List';
  let queryStr = '';
  let filterCourse = 'All';
  let calendarMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  let currentUser = null; // firebase user object or null
  let unsubscribeSnapshot = null; // firestore listener unsubscribe

  // DOM refs
  const viewArea = document.getElementById('viewArea');
  const stats = document.getElementById('stats');
  const quickStats = document.getElementById('quickStats');
  const filterCourseSelect = document.getElementById('filterCourse');
  const searchInput = document.getElementById('search');
  const modalRoot = document.getElementById('modalRoot');
  const authUI = document.getElementById('authUI');
  const storageModeEl = document.getElementById('storageMode');

  // small helpers
  const uid = () => Math.random().toString(36).slice(2,9);
  const formatDate = (iso) => { if(!iso) return '—'; try { return new Date(iso).toLocaleString('vi-VN',{dateStyle:'medium',timeStyle:'short'});} catch(e){return iso;}};
  const dateOnlyISO = (iso) => { if(!iso) return null; const d = new Date(iso); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; };
  const daysUntil = (iso) => { if(!iso) return null; const now=new Date(); const d=new Date(iso); const diff=Math.ceil((d-now)/(1000*60*60*24)); if(diff===0) return 'today'; if(diff>0) return diff+'d'; return Math.abs(diff)+'d ago'; };

  // seed generator reused
  function seedTasks(n=30){
    const courses = ['Cơ sở dữ liệu','Mạch điện tử','Giải tích','Lập trình C','Điện tử số','Hệ điều hành','Machine Learning','Đồ án'];
    const pri = ['Low','Medium','High'];
    const out = [];
    for(let i=0;i<n;i++){
      const due = new Date(); due.setDate(due.getDate() + Math.floor(Math.random()*45)-5);
      const duration = [30,45,60,90,120][Math.floor(Math.random()*5)];
      out.push({
        id: uid(),
        title: `Task ${i+1} — ${courses[i % courses.length]}`,
        notes: 'Mô tả ngắn cho nhiệm vụ này.',
        course: courses[i % courses.length],
        dueDate: due.toISOString(),
        durationMinutes: duration,
        priority: pri[Math.floor(Math.random()*pri.length)],
        done: Math.random() > 0.6,
        createdAt: new Date().toISOString()
      });
    }
    return out;
  }

  // ---- Storage engine abstraction ----
  // Two modes:
  // - If firebaseAvailable && logged in => Firestore per-user
  // - Else => localStorage guest mode
  function setStorageModeLabel(){
    if(firebaseAvailable && currentUser) storageModeEl.textContent = `Firestore (${currentUser.email})`;
    else if(firebaseAvailable) storageModeEl.textContent = 'Firebase (not signed in)';
    else storageModeEl.textContent = 'guest (localStorage)';
  }

  // Load tasks (either local or subscribe to Firestore)
  async function loadTasksForCurrentState(){
    // unsubscribe any previous snapshot
    if(unsubscribeSnapshot) { try { unsubscribeSnapshot(); } catch(e){}; unsubscribeSnapshot = null; }
    if(firebaseAvailable && currentUser){
      // subscribe to user's tasks collection (realtime)
      const userTasksPath = `users/${currentUser.uid}/tasks`;
      const colRef = firebase.firestore ? firebase.firestore().collection(userTasksPath) : null; // placeholder (not used)
      // Using dynamic imports earlier gave us db variable only; but to keep code small we'll call Firestore functions via simpler pattern:
      // For modular SDK used above we need to re-import the functions we need. We'll do that now:
      const { collection, query, orderBy, onSnapshot } = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js').then(m => ({ collection: m.collection, query: m.query, orderBy: m.orderBy, onSnapshot: m.onSnapshot })).catch(()=>({}));
      // BUT the above modular import methods are complex when used this way — instead, we'll use a simpler realtime approach:
      // We'll perform a one-time read and then set up onSnapshot using modular functions already loaded earlier (if available via db variable).
    }

    if(firebaseAvailable && currentUser){
      // Use onSnapshot from the modular SDK — we imported it earlier when initializing (the variable db exists).
      // To avoid re-import complexity, we'll reference onSnapshot, collection, query, orderBy from global scope via direct import:
      try {
        const modDb = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
        const col = modDb.collection ? modDb.collection : (path => {}); // fallback
        // Build query and listener:
        const colRef = modDb.collection ? modDb.collection(db, `users/${currentUser.uid}/tasks`) : modDb.collection(db, `users/${currentUser.uid}/tasks`);
        // Actually use modular functions:
        const { collection: colFn, query: qFn, orderBy: obFn, onSnapshot: onSnapFn } = modDb;
        const q = qFn(colFn(db, `users/${currentUser.uid}/tasks`), obFn('createdAt', 'desc'));
        unsubscribeSnapshot = onSnapFn(q, (snapshot) => {
          tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          render();
        }, (err) => { console.error('snapshot err', err); });
        // done: real-time updates
      } catch (err) {
        console.error('Failed to set snapshot listener', err);
        // fallback to one-time fetch:
        try {
          const modDb2 = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
          const { collection: cf, getDocs, query: qf, orderBy: obf } = modDb2;
          const q = qf(cf(db, `users/${currentUser.uid}/tasks`), obf('createdAt', 'desc'));
          const snapshot = await getDocs(q);
          tasks = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
          render();
        } catch (e2) { console.error(e2); tasks = []; render(); }
      }
    } else {
      // guest localStorage mode
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        try { tasks = JSON.parse(raw); } catch (e) { tasks = seedTasks(30); }
      } else {
        tasks = seedTasks(30);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
      }
      render();
    }
    setStorageModeLabel();
  }

  async function addTask(payload){
    if(firebaseAvailable && currentUser){
      // add to Firestore under users/{uid}/tasks
      const modDb = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
      const { collection, addDoc } = modDb;
      const ref = await addDoc(collection(db, `users/${currentUser.uid}/tasks`), { ...payload, createdAt: new Date().toISOString() });
      // Firestore snapshot will update local tasks automatically
      return ref.id;
    } else {
      const item = { id: uid(), createdAt: new Date().toISOString(), ...payload };
      tasks.unshift(item);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
      render();
      return item.id;
    }
  }

  async function updateTask(id, patch){
    if(firebaseAvailable && currentUser){
      const modDb = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
      const { doc, updateDoc } = modDb;
      await updateDoc(doc(db, `users/${currentUser.uid}/tasks`, id), patch);
    } else {
      tasks = tasks.map(t => t.id === id ? { ...t, ...patch } : t);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
      render();
    }
  }

  async function removeTask(id){
    if(!confirm('Delete this task?')) return;
    if(firebaseAvailable && currentUser){
      const modDb = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
      const { doc, deleteDoc } = modDb;
      await deleteDoc(doc(db, `users/${currentUser.uid}/tasks`, id));
    } else {
      tasks = tasks.filter(t => t.id !== id);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
      render();
    }
  }

  // export/import (works from guest or signed user: export will export currently loaded tasks)
  document.getElementById('seedBtn').addEventListener('click', async () => {
    if(firebaseAvailable && currentUser){
      if(!confirm('Seed 30 tasks for this user? This will add 30 demo tasks to the user collection.')) return;
      const seeds = seedTasks(30);
      for(const s of seeds){
        await addTask(s);
      }
      alert('Seeded 30 tasks (check your list).');
    } else {
      if(!confirm('Replace local tasks with 30 seeded tasks?')) return;
      tasks = seedTasks(30); localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); render();
    }
  });
  document.getElementById('clearBtn').addEventListener('click', async () => {
    if(firebaseAvailable && currentUser){
      if(!confirm('Clear all tasks for this user? This will delete all tasks in Firestore for your account.')) return;
      // fetch user tasks and delete them (note: Firestore batch deletes might be needed for >500 docs)
      const modDb = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js');
      const { collection, getDocs, doc, deleteDoc } = modDb;
      const qSnap = await getDocs(collection(db, `users/${currentUser.uid}/tasks`));
      for(const d of qSnap.docs) await deleteDoc(doc(db, `users/${currentUser.uid}/tasks`, d.id));
      alert('Cleared tasks.');
    } else {
      if(!confirm('Clear ALL local tasks?')) return;
      tasks = []; localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); render();
    }
  });

  // auth UI & handlers
  function renderAuthUI(){
    authUI.innerHTML = '';
    if(firebaseAvailable){
      if(currentUser){
        // show user info + sign out button
        const wrap = document.createElement('div');
        wrap.style.display = 'flex'; wrap.style.alignItems = 'center'; wrap.style.gap = '8px';
        const pill = document.createElement('div'); pill.className = 'user-pill'; pill.textContent = currentUser.email;
        const btnOut = document.createElement('button'); btnOut.className = 'btn-small'; btnOut.textContent = 'Sign out';
        btnOut.addEventListener('click', async () => {
          const modAuth = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
          const { signOut } = modAuth;
          await signOut(modAuth.getAuth());
        });
        wrap.appendChild(pill); wrap.appendChild(btnOut);
        authUI.appendChild(wrap);
      } else {
        const btn = document.createElement('button'); btn.id = 'openLogin2'; btn.className = 'btn-small'; btn.textContent = 'Sign in / Register';
        btn.addEventListener('click', openAuthModal);
        authUI.appendChild(btn);
      }
    } else {
      // guest mode — show simple label
      authUI.innerHTML = `<div class="muted small">guest mode</div>`;
    }
  }

  function openAuthModal(){
    const html = `
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="authEmail" type="email" placeholder="Email" />
        <input id="authPass" type="password" placeholder="Password (6+ chars)" />
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="authClose" class="btn-small">Close</button>
          <button id="authSignIn" class="btn-small">Sign in</button>
          <button id="authSignUp" class="btn-primary">Register</button>
        </div>
        <div class="muted small">Tip: enable Email/Password sign-in in Firebase console and add firebaseConfig above.</div>
      </div>
    `;
    showModal('Sign in / Register', html);
    document.getElementById('authClose').addEventListener('click', closeModal);
    document.getElementById('authSignIn').addEventListener('click', async () => {
      const email = document.getElementById('authEmail').value.trim();
      const pass = document.getElementById('authPass').value;
      if(!email || !pass) return alert('Enter email and password');
      try {
        const modAuth = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
        const { getAuth, signInWithEmailAndPassword } = modAuth;
        const a = getAuth();
        await signInWithEmailAndPassword(a, email, pass);
        closeModal();
      } catch (e) { alert('Sign in failed: ' + (e.message || e)); }
    });
    document.getElementById('authSignUp').addEventListener('click', async () => {
      const email = document.getElementById('authEmail').value.trim();
      const pass = document.getElementById('authPass').value;
      if(!email || !pass) return alert('Enter email and password');
      try {
        const modAuth = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
        const { getAuth, createUserWithEmailAndPassword } = modAuth;
        const a = getAuth();
        const cred = await createUserWithEmailAndPassword(a, email, pass);
        // Optionally create an initial Firestore profile doc here
        closeModal();
        alert('Account created — you are signed in.');
      } catch (e) { alert('Register failed: ' + (e.message || e)); }
    });
  }

  // onAuthStateChanged hook if firebase available
  if(firebaseAvailable){
    const modAuth = await import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js');
    const { getAuth, onAuthStateChanged } = modAuth;
    const a = getAuth();
    onAuthStateChanged(a, (user) => {
      if(user){
        currentUser = user;
      } else currentUser = null;
      renderAuthUI();
      setStorageModeLabel();
      loadTasksForCurrentState();
    });
  } else {
    // no firebase: initial load
    renderAuthUI();
    loadTasksForCurrentState();
  }

  // ---- Rendering (reuse previous rendering functions) ----
  function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

  function allCourses(){ const s = new Set(tasks.map(t=>t.course||'Others')); return ['All', ...Array.from(s)]; }
  function filteredTasks(){ return tasks.filter(t => { const q = queryStr.trim().toLowerCase(); const matchesQ = !q || (t.title && t.title.toLowerCase().includes(q)) || (t.notes && t.notes.toLowerCase().includes(q)); const matchesCourse = filterCourse === 'All' || t.course === filterCourse; return matchesQ && matchesCourse; }); }

  function render(){
    populateCourseFilter();
    const list = filteredTasks();
    stats.innerHTML = `Showing <b>${list.length}</b> tasks • Stored: <b>${firebaseAvailable && currentUser ? 'Firestore (per-user)' : 'localStorage (guest)'} </b>`;
    quickStats.innerHTML = `Total tasks: <b>${tasks.length}</b><br>Done: <b>${tasks.filter(t=>t.done).length}</b><br>Upcoming (7d): <b>${tasks.filter(t=>{ const d=new Date(t.dueDate); const diff=(d - new Date())/(1000*60*60*24); return diff>=0 && diff<=7}).length}</b>`;

    if(view === 'List') renderList(list);
    else if(view === 'Timeline') renderTimeline(list);
    else if(view === 'Course') renderCourse(list);
    else if(view === 'Calendar') renderCalendar();
  }

  function renderList(list){
    const wrap = document.createElement('div'); wrap.className='grid cards';
    list.slice(0,200).forEach(t => {
      const card = document.createElement('div'); card.className='task-card'; if(t.done) card.classList.add('done');
      card.innerHTML = `
        <div class="space-between">
          <div>
            <div class="task-title">${escapeHtml(t.title)}</div>
            <div class="muted">${escapeHtml(t.course || '—')} • ${formatDate(t.dueDate)}</div>
          </div>
          <div class="small muted">
            ${t.priority || ''}<br>
            <div style="margin-top:8px">
              <button class="btn-small" data-action="toggle" data-id="${t.id}">${t.done ? 'Undo' : 'Done'}</button>
              <button class="btn-small" data-action="edit" data-id="${t.id}">Edit</button>
              <button class="btn-small btn-danger" data-action="delete" data-id="${t.id}">Delete</button>
            </div>
          </div>
        </div>
        <div style="margin-top:8px" class="muted small">${escapeHtml(t.notes || '')}</div>
        <div style="margin-top:8px" class="small muted">Duration: ${t.durationMinutes || '—'} min</div>
      `;
      wrap.appendChild(card);
    });
    viewArea.innerHTML=''; viewArea.appendChild(wrap);
    viewArea.querySelectorAll('button[data-action]').forEach(b => {
      const id = b.dataset.id; const act = b.dataset.action;
      b.addEventListener('click', async () => {
        if(act === 'toggle') await updateTask(id, { done: !tasks.find(x=>x.id===id).done });
        else if(act === 'delete') await removeTask(id);
        else if(act === 'edit') openEditModal(id);
      });
    });
  }

  function renderTimeline(list){
    const wrap = document.createElement('div'); wrap.className='grid';
    const sorted = [...list].sort((a,b)=> new Date(a.dueDate||0) - new Date(b.dueDate||0));
    sorted.forEach(t=>{
      const row = document.createElement('div'); row.className='panel';
      row.innerHTML = `
        <div class="space-between">
          <div>
            <div class="task-title">${escapeHtml(t.title)}</div>
            <div class="muted">${escapeHtml(t.course||'—')} • ${formatDate(t.dueDate)}</div>
          </div>
          <div class="small muted">
            ${daysUntil(t.dueDate)}<br>
            <div style="margin-top:8px">
              <button class="btn-small" data-action="edit" data-id="${t.id}">Edit</button>
              <button class="btn-small btn-danger" data-action="delete" data-id="${t.id}">Delete</button>
            </div>
          </div>
        </div>
      `;
      wrap.appendChild(row);
    });
    viewArea.innerHTML=''; viewArea.appendChild(wrap);
    viewArea.querySelectorAll('button[data-action]').forEach(b => {
      const id = b.dataset.id; const act = b.dataset.action;
      b.addEventListener('click', async ()=> act==='delete' ? await removeTask(id) : openEditModal(id));
    });
  }

  function renderCourse(list){
    const byCourse = {}; list.forEach(t=>{ const k=t.course||'Others'; (byCourse[k]=byCourse[k]||[]).push(t);});
    const wrap = document.createElement('div'); wrap.className='grid';
    Object.entries(byCourse).forEach(([courseName, items])=>{
      const block = document.createElement('div'); block.className='panel';
      block.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><b>${escapeHtml(courseName)}</b> <span class="muted small">(${items.length})</span></div></div>`;
      const grid = document.createElement('div'); grid.className='grid cards'; grid.style.marginTop='8px';
      items.forEach(t=>{
        const c = document.createElement('div'); c.className='task-card'; if(t.done) c.classList.add('done');
        c.innerHTML = `<div class="task-title">${escapeHtml(t.title)}</div>
          <div class="muted small">${formatDate(t.dueDate)}</div>
          <div style="margin-top:8px" class="muted small">${escapeHtml(t.notes||'')}</div>
          <div style="margin-top:8px">
            <button class="btn-small" data-action="toggle" data-id="${t.id}">${t.done ? 'Undo' : 'Done'}</button>
            <button class="btn-small" data-action="edit" data-id="${t.id}">Edit</button>
            <button class="btn-small btn-danger" data-action="delete" data-id="${t.id}">Delete</button>
          </div>`;
        grid.appendChild(c);
      });
      block.appendChild(grid);
      wrap.appendChild(block);
    });
    viewArea.innerHTML=''; viewArea.appendChild(wrap);
    viewArea.querySelectorAll('button[data-action]').forEach(b => {
      const id = b.dataset.id; const act = b.dataset.action;
      b.addEventListener('click', async ()=> {
        if(act==='toggle') await updateTask(id, { done: !tasks.find(x=>x.id===id).done });
        if(act==='edit') openEditModal(id);
        if(act==='delete') await removeTask(id);
      });
    });
  }

  function monthGrid(monthDate){
    const start = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
    const firstWeekday = start.getDay();
    const days = [];
    for(let i=0;i<42;i++){ const d=new Date(start); d.setDate(1 + i - firstWeekday); days.push(d);}
    return days;
  }
  function tasksByDayMap(){ const map = {}; tasks.forEach(t => { if(!t.dueDate) return; const key = dateOnlyISO(t.dueDate); map[key] = map[key]||[]; map[key].push(t); }); return map; }

  function renderCalendar(){
    const month = calendarMonth;
    const header = document.createElement('div'); header.className='panel'; header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
    header.innerHTML = `<div><b>${month.toLocaleString('vi-VN',{month:'long', year:'numeric'})}</b></div>
      <div style="display:flex;gap:8px">
        <button id="prevMonth" class="btn-small">&lt; Prev</button>
        <button id="todayMonth" class="btn-small">Today</button>
        <button id="nextMonth" class="btn-small">Next &gt;</button>
      </div>`;
    const gridWrap = document.createElement('div'); gridWrap.style.marginTop='10px';
    const weekhead = document.createElement('div'); weekhead.className='calendar-grid'; weekhead.style.gridTemplateColumns='repeat(7,1fr)'; weekhead.style.marginBottom='8px';
    ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => { const el=document.createElement('div'); el.style.fontWeight='600'; el.style.textAlign='center'; el.textContent=d; weekhead.appendChild(el);});
    const grid = document.createElement('div'); grid.className='calendar-grid';
    const days = monthGrid(month);
    const tmap = tasksByDayMap();
    days.forEach(day=>{
      const key = dateOnlyISO(day.toISOString());
      const cell = document.createElement('div'); cell.className='cal-cell'; if(day.getMonth()!==month.getMonth()) cell.classList.add('cal-other');
      const headerLine = document.createElement('div'); headerLine.className='cal-day';
      const dayNumber = document.createElement('div'); dayNumber.textContent = day.getDate();
      if(dateOnlyISO(new Date().toISOString()) === key) dayNumber.style.color = 'var(--accent)';
      const count = document.createElement('div'); count.className='muted small'; count.textContent=(tmap[key]||[]).length;
      headerLine.appendChild(dayNumber); headerLine.appendChild(count);
      cell.appendChild(headerLine);
      const list = document.createElement('div'); list.style.marginTop='8px'; list.style.fontSize='13px';
      (tmap[key]||[]).slice(0,3).forEach(t=>{ const li=document.createElement('div'); li.textContent='• '+t.title; li.style.whiteSpace='nowrap'; li.style.overflow='hidden'; li.style.textOverflow='ellipsis'; list.appendChild(li); });
      cell.appendChild(list);
      cell.addEventListener('click', ()=> openDayTasks(key));
      grid.appendChild(cell);
    });
    gridWrap.appendChild(weekhead); gridWrap.appendChild(grid);
    viewArea.innerHTML=''; viewArea.appendChild(header); viewArea.appendChild(gridWrap);
    document.getElementById('prevMonth').addEventListener('click', ()=>{ calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth()-1,1); render();});
    document.getElementById('nextMonth').addEventListener('click', ()=>{ calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth()+1,1); render();});
    document.getElementById('todayMonth').addEventListener('click', ()=>{ calendarMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1); render();});
  }

  function openDayTasks(dateISO){
    const items = tasks.filter(t => dateOnlyISO(t.dueDate) === dateISO);
    let html = `<div style="display:flex;justify-content:space-between;align-items:center"><div><b>Tasks on ${dateISO}</b></div><div><button id="closeDay" class="btn-small">Close</button></div></div><div style="margin-top:8px">`;
    items.forEach(t=>{
      html += `<div class="task-card" style="margin-bottom:8px">
        <div class="space-between"><div><div class="task-title">${escapeHtml(t.title)}</div><div class="muted small">${escapeHtml(t.course||'—')} • ${formatDate(t.dueDate)}</div></div>
          <div class="small muted"><button class="btn-small" data-id="${t.id}" data-act="edit">Edit</button> <button class="btn-small btn-danger" data-id="${t.id}" data-act="delete">Delete</button></div>
        </div>
        <div style="margin-top:8px" class="muted small">${escapeHtml(t.notes||'')}</div>
      </div>`;
    });
    html += '</div>';
    showModal('Day tasks', html, () => {});
    document.getElementById('closeDay').addEventListener('click', closeModal);
    document.querySelectorAll('[data-act]').forEach(b => {
      b.addEventListener('click', async ()=> {
        const id = b.dataset.id; const a = b.dataset.act;
        closeModal();
        if(a==='edit') openEditModal(id); else if(a==='delete') await removeTask(id);
      });
    });
  }

  // Modal helpers
  function showModal(title, innerHTML){
    modalRoot.style.display = 'block';
    modalRoot.innerHTML = `<div class="modal-back"><div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center"><div><b>${escapeHtml(title)}</b></div><div><button id="closeModal" class="btn-small">Close</button></div></div>
      <div style="margin-top:10px">${innerHTML}</div>
    </div></div>`;
    document.getElementById('closeModal').addEventListener('click', closeModal);
  }
  function closeModal(){ modalRoot.style.display='none'; modalRoot.innerHTML=''; }

  // Add / Edit modals
  function openAddModal(){
    const html = `
      <div class="row">
        <div class="col"><input id="mTitle" placeholder="Tiêu đề" type="text" style="width:100%"/></div>
        <div style="width:160px"><input id="mCourse" placeholder="Môn / Nhóm" type="text" style="width:100%"/></div>
      </div>
      <div style="margin-top:8px" class="row">
        <div class="col"><label class="muted small">Due date (local)</label><input id="mDue" type="datetime-local" style="width:100%"/></div>
        <div style="width:140px"><label class="muted small">Duration (min)</label><input id="mDuration" type="number" min="5" step="5" value="60" style="width:100%"/></div>
        <div style="width:120px"><label class="muted small">Priority</label><select id="mPriority" style="width:100%"><option>Low</option><option selected>Medium</option><option>High</option></select></div>
      </div>
      <div style="margin-top:8px"><textarea id="mNotes" rows="4" placeholder="Ghi chú" style="width:100%"></textarea></div>
      <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px"><button id="mCancel" class="btn-small">Cancel</button><button id="mSave" class="btn-primary">Save</button></div>
    `;
    showModal('Add task', html);
    document.getElementById('mCancel').addEventListener('click', closeModal);
    document.getElementById('mSave').addEventListener('click', async ()=>{
      const payload = {
        title: (document.getElementById('mTitle').value||'').trim(),
        notes: document.getElementById('mNotes').value||'',
        course: (document.getElementById('mCourse').value||'Lớp chung').trim(),
        dueDate: (()=>{ const v=document.getElementById('mDue').value; return v ? new Date(v).toISOString() : null; })(),
        durationMinutes: Number(document.getElementById('mDuration').value) || 60,
        priority: document.getElementById('mPriority').value,
        done: false
      };
      if(!payload.title) return alert('Tiêu đề không được để trống');
      await addTask(payload);
      closeModal();
    });
  }

  function openEditModal(id){
    const t = tasks.find(x=>x.id === id); if(!t) return alert('Task not found');
    const dueLocal = t.dueDate ? new Date(t.dueDate).toISOString().slice(0,16) : '';
    const html = `
      <div class="row"><div class="col"><input id="mTitle" value="${escapeHtml(t.title)}" placeholder="Tiêu đề" type="text" style="width:100%"/></div>
      <div style="width:160px"><input id="mCourse" value="${escapeHtml(t.course)}" placeholder="Môn / Nhóm" type="text" style="width:100%"/></div></div>
      <div style="margin-top:8px" class="row"><div class="col"><label class="muted small">Due date (local)</label><input id="mDue" type="datetime-local" value="${dueLocal}" style="width:100%"/></div>
      <div style="width:140px"><label class="muted small">Duration (min)</label><input id="mDuration" type="number" min="5" step="5" value="${escapeHtml(String(t.durationMinutes||60))}" style="width:100%"/></div>
      <div style="width:120px"><label class="muted small">Priority</label>
      <select id="mPriority" style="width:100%"><option ${t.priority==='Low'?'selected':''}>Low</option><option ${t.priority==='Medium'?'selected':''}>Medium</option><option ${t.priority==='High'?'selected':''}>High</option></select></div></div>
      <div style="margin-top:8px"><textarea id="mNotes" rows="4" style="width:100%">${escapeHtml(t.notes||'')}</textarea></div>
      <div style="margin-top:10px;display:flex;justify-content:space-between;gap:8px">
        <div><label><input id="mDone" type="checkbox" ${t.done ? 'checked' : ''}/> Done</label></div>
        <div style="display:flex;gap:8px"><button id="mDelete" class="btn-small btn-danger">Delete</button><button id="mCancel" class="btn-small">Cancel</button><button id="mSave" class="btn-primary">Save</button></div>
      </div>
    `;
    showModal('Edit task', html);
    document.getElementById('mCancel').addEventListener('click', closeModal);
    document.getElementById('mDelete').addEventListener('click', async ()=>{ closeModal(); await removeTask(id); });
    document.getElementById('mSave').addEventListener('click', async ()=>{
      const payload = {
        title: (document.getElementById('mTitle').value||'').trim(),
        notes: document.getElementById('mNotes').value||'',
        course: (document.getElementById('mCourse').value||'Lớp chung').trim(),
        dueDate: (()=>{ const v=document.getElementById('mDue').value; return v ? new Date(v).toISOString() : null; })(),
        durationMinutes: Number(document.getElementById('mDuration').value) || 60,
        priority: document.getElementById('mPriority').value,
        done: !!document.getElementById('mDone').checked
      };
      if(!payload.title) return alert('Tiêu đề không được để trống');
      await updateTask(id, payload);
      closeModal();
    });
  }

  // populate filter select
  function populateCourseFilter(){
    const courses = allCourses();
    filterCourseSelect.innerHTML = courses.map(c => `<option ${c===filterCourse?'selected':''}>${escapeHtml(c)}</option>`).join('');
    filterCourseSelect.onchange = e => { filterCourse = e.target.value; render(); };
  }

  // view switches
  document.querySelectorAll('[data-view]').forEach(b => b.addEventListener('click', ()=> { view = b.dataset.view; document.querySelectorAll('[data-view]').forEach(x=>{ x.style.background = x.dataset.view===view ? 'var(--accent)' : ''; x.style.color = x.dataset.view===view ? 'white' : ''; }); render(); }));

  // add, search
  document.getElementById('btnAdd').addEventListener('click', ()=> { if(firebaseAvailable && !currentUser){ alert('Please sign in to store tasks in your account. You can still use guest mode without signing in.'); openAuthModal(); return; } openAddModal(); });
  searchInput.addEventListener('input', (e)=>{ queryStr = e.target.value; render(); });

  // keyboard navigation for calendar
  document.addEventListener('keydown', (e)=>{ if(view !== 'Calendar') return; if(e.key === 'ArrowLeft'){ calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth()-1,1); render(); } if(e.key === 'ArrowRight'){ calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth()+1,1); render(); } });

  // initial render placeholders
  function setInitialUI(){ renderAuthUI(); setStorageModeLabel(); render(); }

  // run initial UI (either authenticated state listener triggers load, or guest mode uses localStorage)
  setInitialUI();

  // When firebase is available and user signs in/out we will call loadTasksForCurrentState via onAuthStateChanged earlier
  // For guests, tasks were loaded earlier when page started.

  // Also wire export/import controls (exists in header? we include quick export via right-click or below)
  // Simple export button appended to extras
  const exportBtn = document.createElement('button'); exportBtn.className = 'btn-small'; exportBtn.textContent = 'Export JSON';
  exportBtn.addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(tasks, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'vn-student-planner-tasks.json'; a.click(); URL.revokeObjectURL(url);
  });
  document.getElementById('extras').appendChild(exportBtn);
  // import control
  const impLabel = document.createElement('label'); impLabel.className='btn-small'; impLabel.style.cursor='pointer'; impLabel.textContent='Import JSON';
  const impInput = document.createElement('input'); impInput.type='file'; impInput.accept='application/json'; impInput.style.display='none';
  impInput.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=async ()=>{ try{ const imported = JSON.parse(r.result); if(Array.isArray(imported)){ if(firebaseAvailable && currentUser){ for(const it of imported){ await addTask(it); } alert('Imported to your account.'); } else { tasks = [...imported, ...tasks]; localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); render(); alert('Imported into local storage.'); } } else alert('JSON must be an array of tasks'); } catch(err){ alert('Invalid JSON'); } }; r.readAsText(f); });
  impLabel.appendChild(impInput); impLabel.addEventListener('click', ()=> impInput.click());
  document.getElementById('extras').appendChild(impLabel);

  // ensure loadTasksForCurrentState called when firebase auth changes (we set that up above)
  // If no firebase, loadTasksForCurrentState was called earlier in auth init.

  </script>
</body>
</html>
